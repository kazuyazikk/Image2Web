<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thesis Web Editor – HTML/CSS/JS + Preview</title>
  <!-- Optional ZIP exporter (uses CDN). If offline, ZIP export will be disabled gracefully. -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
  <style>
    /*
      =============================================================
      FINAL THESIS EDITOR (READABLE VANILLA IMPLEMENTATION)
      -------------------------------------------------------------
      - Three editors: HTML, CSS, JS
      - Load from local files, paste URLs (e.g., Firebase), or type manually
      - Refreshable sandboxed preview (NOT realtime, by design)
      - Autosave to localStorage (survives reloads)
      - Import/Export project as JSON
      - Export project as ZIP (index.html, style.css, script.js)
      - Light/Dark theme toggle
      - Drag-to-resize split between Editors and Preview
      - Basic JS syntax check with inline feedback
      -------------------------------------------------------------
      Tip: Keep this single file in your repo as a self-contained demo page.
    */

    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --muted: #111827;
      --text: #e5e7eb;
      --border: #334155;
      --accent: #22d3ee;
      --good: #34d399;
      --warn: #f59e0b;
      --bad: #ef4444;
      --btn: #1f2937;
      --btn-hover: #374151;
    }
    .light {
      --bg: #f8fafc;
      --panel: #ffffff;
      --muted: #f1f5f9;
      --text: #0f172a;
      --border: #cbd5e1;
      --accent: #0891b2;
      --good: #059669;
      --warn: #b45309;
      --bad: #b91c1c;
      --btn: #e2e8f0;
      --btn-hover: #cbd5e1;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 5;
    }
    .brand { font-weight: 800; letter-spacing: .3px; margin-right: 8px; }
    .spacer { flex: 1; }
    .btn {
      border: 1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .06s ease, background .15s ease;
      font-size: 14px; line-height: 1;
      display: inline-flex; align-items: center; gap: 8px;
      text-decoration: none; user-select: none;
    }
    .btn:hover { background: var(--btn-hover); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: transparent; box-shadow: 0 0 0 1px inset var(--accent); }
    .btn.success { border-color: transparent; box-shadow: 0 0 0 1px inset var(--good); }
    .btn.warn { border-color: transparent; box-shadow: 0 0 0 1px inset var(--warn); }

    input[type=file] { display: none; }

    /* Main split layout */
    .app {
      display: grid;
      grid-template-columns: 1fr 10px 1fr; /* editors | handle | preview */
      min-height: 0; /* allow children to shrink */
    }
    .panel {
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 0;
    }

    /* Drag handle */
    .handle {
      background: linear-gradient(to bottom, transparent 0, transparent 10px, var(--border) 10px, var(--border) 14px, transparent 14px, transparent 100%);
      cursor: col-resize;
    }

    /* Editors column */
    .editors-header {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
      padding: 10px; border-bottom: 1px solid var(--border); background: var(--muted);
    }
    .editors {
      display: grid; grid-template-rows: 1fr 1fr 1fr; gap: 10px; padding: 10px; min-height: 0;
    }
    .editor {
      border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: grid; grid-template-rows: auto 1fr;
    }
    .editor .header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; background: var(--muted); border-bottom:1px solid var(--border); font-size:12px; }
    .editor textarea { width:100%; height:100%; border:none; outline:none; padding:10px; background: transparent; color: var(--text); resize:none; font-size:13px; line-height:1.45; tab-size:2; white-space:pre; overflow:auto; }

    .status { font-size: 12px; opacity: .85; }
    .errors { font-size: 12px; padding: 6px 10px; border-top: 1px solid var(--border); background: #00000022; white-space: pre-wrap; max-height: 80px; overflow:auto; }

    /* Preview column */
    .preview-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border-bottom:1px solid var(--border); background: var(--muted); }
    .preview-tools { display:flex; gap:8px; flex-wrap: wrap; }
    iframe { width: 100%; height: 100%; border: none; background: white; }

    .row { display:flex; gap:8px; flex-wrap: wrap; }
    .row input[type=url], .row input[type=text] { width: 340px; max-width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text); }
    .row small { opacity: .8; }

    @media (max-width: 1024px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto 1fr; }
      .handle { display: none; }
      .panel { border-right: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>
  <!-- =================== Top Toolbar =================== -->
  <div class="toolbar">
    <div class="brand">Thesis Web Editor</div>

    <!-- Open local files -->
    <label for="open-html" class="btn" title="Open an .html file into the HTML editor">Open HTML<input id="open-html" type="file" accept=".html,.htm,text/html" /></label>
    <label for="open-css" class="btn" title="Open a .css file into the CSS editor">Open CSS<input id="open-css" type="file" accept=".css,text/css" /></label>
    <label for="open-js" class="btn" title="Open a .js file into the JS editor">Open JS<input id="open-js" type="file" accept=".js,application/javascript,text/javascript" /></label>

    <span class="spacer"></span>

    <!-- Save individual files -->
    <button id="save-html" class="btn" title="Download the current HTML as a file">Save HTML</button>
    <button id="save-css" class="btn" title="Download the current CSS as a file">Save CSS</button>
    <button id="save-js" class="btn" title="Download the current JS as a file">Save JS</button>

    <!-- Project I/O -->
    <button id="export-json" class="btn" title="Export project as .json (html, css, js)">Export JSON</button>
    <label class="btn" title="Import a previously exported project JSON">
      Import JSON
      <input id="import-json" type="file" accept="application/json,.json" />
    </label>
    <button id="export-zip" class="btn" title="Export as a runnable ZIP (index.html, style.css, script.js)">Export ZIP</button>

    <!-- Theme toggle -->
    <button id="toggle-theme" class="btn" title="Toggle light/dark theme">Theme</button>

    <!-- Refresh preview explicitly -->
    <button id="refresh" class="btn primary" title="Rebuild the preview using current editors (not realtime)">Refresh Preview</button>
  </div>

  <!-- =================== App Split =================== -->
  <div class="app" id="app">
    <!-- ========== Editors Column ========== -->
    <section class="panel" id="editors-panel">
      <div class="editors-header">
        <div class="status" id="autosave-status">Autosave ready</div>
        <div class="spacer"></div>
        <div class="row">
          <input id="css-url" type="url" placeholder="Paste CSS URL (e.g., Firebase Storage)" />
          <button id="fetch-css" class="btn" title="Fetch CSS from URL into the editor">Fetch CSS</button>
        </div>
        <div class="row">
          <input id="js-url" type="url" placeholder="Paste JS URL (e.g., Firebase Hosting/Storage)" />
          <button id="fetch-js" class="btn" title="Fetch JS from URL into the editor">Fetch JS</button>
        </div>
      </div>

      <div class="editors">
        <!-- HTML Editor -->
        <div class="editor">
          <div class="header"><strong>HTML</strong><small id="html-name">(unsaved)</small></div>
          <textarea id="html-editor" spellcheck="false"></textarea>
        </div>
        <!-- CSS Editor -->
        <div class="editor">
          <div class="header"><strong>CSS</strong><small id="css-name">(unsaved)</small></div>
          <textarea id="css-editor" spellcheck="false"></textarea>
          <div class="errors" id="css-errors" hidden></div>
        </div>
        <!-- JS Editor -->
        <div class="editor">
          <div class="header"><strong>JavaScript</strong><small id="js-name">(unsaved)</small></div>
          <textarea id="js-editor" spellcheck="false"></textarea>
          <div class="errors" id="js-errors" hidden></div>
        </div>
      </div>
    </section>

    <!-- ========== Drag Handle ========== -->
    <div class="handle" id="handle" title="Drag to resize"></div>

    <!-- ========== Preview Column ========== -->
    <section class="panel" id="preview-panel">
      <div class="preview-header">
        <div class="status" id="status">Waiting for first refresh…</div>
        <div class="preview-tools">
          <button id="quick-sample" class="btn" title="Load a tiny sample into the editors">Load Sample</button>
          <button id="hard-reload" class="btn success" title="Force-recreate the iframe preview">Hard Reload</button>
          <button id="clear-editors" class="btn warn" title="Clear all editors (keeps autosave history until overwritten)">Clear All</button>
        </div>
      </div>
      <iframe id="preview" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
    </section>
  </div>

  <script>
    // ======================== DOM Helpers ========================
    const $ = (sel) => document.querySelector(sel);

    const htmlTA = $('#html-editor');
    const cssTA = $('#css-editor');
    const jsTA = $('#js-editor');
    const iframe = $('#preview');
    const statusEl = $('#status');
    const autosaveStatus = $('#autosave-status');

    const openHtmlInput = $('#open-html');
    const openCssInput = $('#open-css');
    const openJsInput = $('#open-js');

    const saveHtmlBtn = $('#save-html');
    const saveCssBtn = $('#save-css');
    const saveJsBtn = $('#save-js');

    const exportJsonBtn = $('#export-json');
    const importJsonInput = $('#import-json');
    const exportZipBtn = $('#export-zip');

    const refreshBtn = $('#refresh');
    const hardReloadBtn = $('#hard-reload');
    const quickSampleBtn = $('#quick-sample');
    const clearEditorsBtn = $('#clear-editors');

    const cssUrlInput = $('#css-url');
    const jsUrlInput = $('#js-url');
    const fetchCssBtn = $('#fetch-css');
    const fetchJsBtn = $('#fetch-js');

    const toggleThemeBtn = $('#toggle-theme');

    const htmlNameEl = $('#html-name');
    const cssNameEl = $('#css-name');
    const jsNameEl = $('#js-name');

    const cssErrorsEl = $('#css-errors');
    const jsErrorsEl = $('#js-errors');

    // ======================== State & Constants ========================
    const AUTOSAVE_KEY = 'thesis-editor-project';

    function getProject() {
      return {
        html: htmlTA.value || '',
        css: cssTA.value || '',
        js: jsTA.value || ''
      };
    }

    function setProject(p) {
      htmlTA.value = p.html ?? '';
      cssTA.value = p.css ?? '';
      jsTA.value = p.js ?? '';
    }

    // ======================== Build Preview (not realtime) ========================
    function buildPreview() {
      // Basic JS syntax check before injecting
      const js = jsTA.value || '';
      jsErrorsEl.hidden = true; jsErrorsEl.textContent = '';
      if (js.trim()) {
        try {
          // new Function throws SyntaxError for invalid JS
          // This does not execute the code yet; it only validates syntax.
          // eslint-disable-next-line no-new-func
          new Function(js);
        } catch (err) {
          jsErrorsEl.hidden = false;
          jsErrorsEl.textContent = 'JS Syntax Error: ' + err.message;
          statusEl.textContent = 'Preview not updated due to JS syntax error.';
          return;
        }
      }

      const doc = `<!doctype html>\n<html>\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1">\n<style>\n${cssTA.value || ''}\n</style>\n</head>\n<body>\n${htmlTA.value || ''}\n<script>\n${js}\n<\/script>\n</body>\n</html>`;

      iframe.srcdoc = doc;
      statusEl.textContent = `Preview refreshed at ${new Date().toLocaleTimeString()}`;
    }

    function hardReloadPreview() {
      const parent = iframe.parentNode;
      const fresh = document.createElement('iframe');
      fresh.id = 'preview';
      fresh.setAttribute('sandbox', 'allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts');
      parent.replaceChild(fresh, iframe);
      // Update reference then build again
      window.setTimeout(() => {
        const newIframe = document.getElementById('preview');
        const doc = `<!doctype html>\n<html>\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1">\n<style>\n${cssTA.value || ''}\n</style>\n</head>\n<body>\n${htmlTA.value || ''}\n<script>\n${jsTA.value || ''}\n<\/script>\n</body>\n</html>`;
        newIframe.srcdoc = doc;
        statusEl.textContent = `Hard reloaded at ${new Date().toLocaleTimeString()}`;
      }, 0);
    }

    // ======================== File Helpers ========================
    function readTextFile(file, onDone) {
      const reader = new FileReader();
      reader.onload = () => onDone(reader.result, file.name);
      reader.onerror = () => alert('Failed to read file: ' + file.name);
      reader.readAsText(file);
    }

    function download(filename, text, type = 'text/plain') {
      const blob = new Blob([text], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ======================== Open/Save per file ========================
    openHtmlInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      readTextFile(f, (text, name) => { htmlTA.value = text; htmlNameEl.textContent = name || '(unsaved)'; autosaveNow(); });
      e.target.value = '';
    });
    openCssInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      readTextFile(f, (text, name) => { cssTA.value = text; cssNameEl.textContent = name || '(unsaved)'; autosaveNow(); });
      e.target.value = '';
    });
    openJsInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      readTextFile(f, (text, name) => { jsTA.value = text; jsNameEl.textContent = name || '(unsaved)'; autosaveNow(); });
      e.target.value = '';
    });

    saveHtmlBtn.addEventListener('click', () => {
      const suggested = htmlNameEl.textContent && htmlNameEl.textContent !== '(unsaved)' ? htmlNameEl.textContent : 'index.html';
      download(suggested, htmlTA.value, 'text/html');
    });
    saveCssBtn.addEventListener('click', () => {
      const suggested = cssNameEl.textContent && cssNameEl.textContent !== '(unsaved)' ? cssNameEl.textContent : 'style.css';
      download(suggested, cssTA.value, 'text/css');
    });
    saveJsBtn.addEventListener('click', () => {
      const suggested = jsNameEl.textContent && jsNameEl.textContent !== '(unsaved)' ? jsNameEl.textContent : 'script.js';
      download(suggested, jsTA.value, 'text/javascript');
    });

    // ======================== Project JSON I/O ========================
    exportJsonBtn.addEventListener('click', () => {
      const json = JSON.stringify(getProject(), null, 2);
      download('project.json', json, 'application/json');
    });

    importJsonInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      readTextFile(f, (text) => {
        try {
          const p = JSON.parse(text);
          setProject(p); autosaveNow(); buildPreview();
        } catch (err) {
          alert('Invalid JSON: ' + err.message);
        }
      });
      e.target.value = '';
    });

    // ======================== ZIP Export ========================
    exportZipBtn.addEventListener('click', async () => {
      if (typeof JSZip === 'undefined') {
        alert('ZIP export requires internet to load JSZip from CDN. Try again online.');
        return;
      }
      const zip = new JSZip();
      const html = htmlTA.value || '';
      const css = cssTA.value || '';
      const js = jsTA.value || '';

      // Create separate files
      zip.file('style.css', css);
      zip.file('script.js', js);
      // index.html links the two files
      const index = `<!doctype html>\n<html>\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1" />\n<link rel="stylesheet" href="style.css">\n<title>Exported Project</title>\n</head>\n<body>\n${html}\n<script src="script.js"><\/script>\n</body>\n</html>`;
      zip.file('index.html', index);

      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'project.zip';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // ======================== Fetch from URL (Firebase-friendly) ========================
    async function fetchTextTo(targetTA, urlStr, nameEl) {
      if (!urlStr) { alert('Please paste a URL first.'); return; }
      try {
        const res = await fetch(urlStr, { cache: 'no-store' });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const text = await res.text();
        targetTA.value = text;
        if (nameEl) nameEl.textContent = urlStr.split('/').pop() || '(remote)';
        autosaveNow();
      } catch (err) {
        alert('Fetch failed. If this is Firebase Storage, ensure the file is publicly readable or your CORS rules allow it.\n\nError: ' + err.message);
      }
    }
    fetchCssBtn.addEventListener('click', () => fetchTextTo(cssTA, cssUrlInput.value.trim(), cssNameEl));
    fetchJsBtn.addEventListener('click', () => fetchTextTo(jsTA, jsUrlInput.value.trim(), jsNameEl));

    // ======================== Autosave ========================
    function autosaveNow() {
      try {
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(getProject()));
        autosaveStatus.textContent = 'Saved ' + new Date().toLocaleTimeString();
      } catch (_) {
        autosaveStatus.textContent = 'Autosave failed (storage full?)';
      }
    }
    function restoreAutosave() {
      try {
        const raw = localStorage.getItem(AUTOSAVE_KEY);
        if (!raw) return false;
        const p = JSON.parse(raw);
        setProject(p);
        autosaveStatus.textContent = 'Restored autosave';
        return true;
      } catch (_) { return false; }
    }
    [htmlTA, cssTA, jsTA].forEach(el => {
      el.addEventListener('input', () => {
        autosaveStatus.textContent = 'Editing…';
        // Debounced autosave
        clearTimeout(el.__t);
        el.__t = setTimeout(autosaveNow, 400);
      });
    });

    // ======================== Theme Toggle ========================
    function applyInitialTheme() {
      const pref = localStorage.getItem('thesis-theme');
      if (pref === 'light') document.body.classList.add('light');
    }
    toggleThemeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('thesis-theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });

    // ======================== Clear Editors ========================
    clearEditorsBtn.addEventListener('click', () => {
      if (!confirm('Clear all editors? This will overwrite autosave.')) return;
      htmlTA.value = cssTA.value = jsTA.value = '';
      autosaveNow(); buildPreview();
    });

    // ======================== Refresh/Reload ========================
    refreshBtn.addEventListener('click', buildPreview);
    hardReloadBtn.addEventListener('click', hardReloadPreview);

    // ======================== Sample ========================
    quickSampleBtn.addEventListener('click', () => {
      cssTA.value = `:root { --brand: #22d3ee; }\nbody { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; }\n.card { border: 2px solid var(--brand); padding: 16px; border-radius: 12px; max-width: 520px; }\n.card h1 { margin: 0 0 8px 0; font-size: 28px; }\n.card p { margin: 0 0 12px 0; line-height: 1.5; }\n.button { display: inline-block; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--brand); color: #111; text-decoration: none; }\n.button:hover { background: #e0fbff; }`;
      htmlTA.value = `<div class=\"card\">\n  <h1>Hello, thesis 👋</h1>\n  <p>This preview refreshes only when you click <em>Refresh Preview</em>.</p>\n  <a class=\"button\" href=\"#\" onclick=\"alert('JS is working!')\">Test JS</a>\n</div>`;
      jsTA.value = `console.log('Sample JS loaded');`;
      autosaveNow(); buildPreview();
    });

    // ======================== Draggable Split ========================
    (function setupDragSplit(){
      const app = document.getElementById('app');
      const handle = document.getElementById('handle');
      let dragging = false;
      handle.addEventListener('mousedown', (e)=>{ dragging = true; e.preventDefault(); });
      window.addEventListener('mouseup', ()=> dragging = false);
      window.addEventListener('mousemove', (e)=>{
        if (!dragging) return;
        const rect = app.getBoundingClientRect();
        const px = Math.min(Math.max(e.clientX - rect.left, 200), rect.width - 200);
        // Convert to percentage to keep responsive on resize
        const leftPct = (px / rect.width) * 100;
        app.style.gridTemplateColumns = leftPct + 'fr 10px ' + (100 - leftPct) + 'fr';
      });
    })();

    // ======================== Init ========================
    window.addEventListener('DOMContentLoaded', () => {
      applyInitialTheme();
      if (!restoreAutosave()) {
        // First-time load: provide a small sample for clarity
        quickSampleBtn.click();
      }
    });
  </script>
</body>
</html>
