<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Your personal workspace on Image2Web. Manage your projects and conversions here. Designed by SeroTech.">
  <title>CODE4WEB - Your Workspace</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css?family=Russo+One&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    /* Optional: Add a simple loading state or hidden content if you want to prevent flicker */
    body {
      opacity: 0;
      /* Hide body initially */
      transition: opacity 0.5s ease-in-out;
    }

    body.loaded {
      opacity: 1;
      /* Show body once authentication check is done */
    }

    .access-denied-message {
      display: none;
      /* Hidden by default */
      text-align: center;
      margin-top: 50px;
      font-size: 1.5em;
      color: var(--danger-red);
      /* Assuming you have a danger-red variable */
      padding: 30px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--modal-content-bg);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .access-denied-message h2 {
      color: var(--primary-blue);
      margin-bottom: 15px;
    }

    .access-denied-message p {
      margin-bottom: 25px;
      color: var(--text-primary);
    }

    .access-denied-message .hero-btn {
      padding: 10px 30px;
      font-size: 1em;
      border-radius: 50px;
    }


    /* Widget Styles - If these are global and not already in style.css */
    .widget {
      background: #f8fafc;
      border-radius: 8px;
      padding: 1em;
      margin: 1em 0;
      box-shadow: 0 2px 8px rgba(30, 41, 59, 0.04);
    }

    .widget h3 {
      margin-top: 0;
    }

    #todo-list li.done {
      text-decoration: line-through;
      color: #888;
    }

    /* Override for active nav button on this page (header nav) */
    /* I'm keeping this commented out as per our previous discussion to let global style.css rule apply
      for solid background. If you want a border, uncomment and adjust. */
    /* .nav-item.active .nav-btn { */
    /* border: 2px solid #0ea5e9; */
    /* background: transparent; */
    /* color: #0ea5e9; */
    /* } */

    /* General Layout for Workspace Page (copied from previous response) */
    body {
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }

    .main-wrapper {
      display: flex;
      flex-grow: 1;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding-top: 20px;
    }

    .sidebar {
      width: 250px;
      min-width: 200px;
      background: var(--modal-content-bg);
      padding: 20px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 15px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      border-bottom-left-radius: 10px;
      border-top-left-radius: 10px;
    }

    .sidebar-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-nav li a,
    .logout-btn {
      display: block;
      padding: 10px 15px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 5px;
      transition: background 0.2s ease, color 0.2s ease;
      font-size: 1.1em;
    }

    .sidebar-nav li a:hover,
    .logout-btn:hover {
      background: rgba(var(--primary-blue), 0.1);
      color: var(--primary-blue);
    }

    .sidebar-nav li.active a {
      background: var(--primary-blue);
      color: var(--button-text);
      font-weight: bold;
    }

    .sidebar-user {
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      margin-top: auto;
    }

    .sidebar-user p {
      color: var(--text-primary);
      margin-bottom: 10px;
      font-weight: bold;
    }

    .main-content-area {
      flex-grow: 1;
      padding: 20px 40px;
      background: var(--background-light);
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    /* Workspace-specific content containers */
    .workspace-section-card {
      background: var(--modal-content-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .workspace-section-card h2 {
      font-family: 'Russo One', sans-serif;
      color: var(--primary-blue);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.8em;
      text-align: center;
      /* Center the title */
    }

    /* Input and Select Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
      text-align: left;
    }

    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background-color: var(--input-bg);
      color: var(--text-primary);
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      font-size: 1em;
      resize: vertical;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2394A3B8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.4L146.2%20227.3%2018.8%2074.8c-2.9-3-6.4-4.6-10.9-4.6A17.6%2017.6%200%200%200%200%2080.2V212.1c0%203.9%201.5%207.4%204.6%2010.9L146.2%20272.7l141.6-141.6c3-3.5%204.6-7%204.6-10.9V80.2c0-4.5-1.5-8-4.6-10.9z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 10px top 50%;
      background-size: 12px auto;
    }

    /* Image Upload Area */
    .image-upload-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1.5rem;
      border: 2px dashed var(--primary-blue);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      min-height: 150px;
      justify-content: center;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .image-upload-area.drag-over {
      background-color: rgba(56, 189, 248, 0.1);
      border-color: var(--secondary-blue);
    }

    .upload-label {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      background: var(--primary-blue);
      color: var(--button-text);
      border-radius: 50px;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .upload-label:hover {
      background: var(--secondary-blue);
      transform: translateY(-2px);
    }

    #imagePreview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 10px;
      margin-top: 1rem;
      object-fit: contain;
      border: 1px solid var(--border-color);
      display: none;
    }

    /* Code Inspector Area */
    .code-inspector-section {
      background: var(--modal-content-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .code-inspector-section h2 {
      font-family: 'Russo One', sans-serif;
      color: var(--primary-blue);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.8em;
      text-align: center;
      /* Center the title */
    }

    /* Two-pane layout and larger Inspector preview */
    .two-pane-layout {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr;
  gap: 20px;
  align-items: stretch;
    }

    .inspector-pane h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary-blue);
    }

    #inspector-preview {
  width: 100%;
  min-width: 0;
  height: 700px;
  background: #fff;
  border: 2px dashed #38bdf8;
  border-radius: 8px;
    }

    .code-display {
      background-color: var(--input-bg);
      color: var(--text-primary);
      font-family: 'Fira Code', 'Monaco', monospace;
      font-size: 0.9em;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      min-height: 200px;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid var(--border-color);
    }

    .code-display.empty-state {
      color: var(--text-secondary);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .download-code-btn {
      background: var(--tertiary-blue);
      color: var(--button-text);
      padding: 10px 20px;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .download-code-btn:hover {
      background: #0ea5e9;
      transform: translateY(-2px);
    }

    /* Media Queries for Responsive Layout */
    @media (max-width: 900px) {
      .main-wrapper {
        flex-direction: column;
        padding-top: 0;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        border-radius: 0;
        padding: 15px 20px;
      }

      .sidebar-nav ul {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }

      .sidebar-nav li a {
        padding: 8px 12px;
        font-size: 1em;
      }

      .sidebar-user {
        border-top: none;
        padding-top: 0;
        margin-top: 15px;
        text-align: center;
      }

      .main-content-area {
        padding: 20px;
        border-radius: 0;
        max-width: 100%;
      }

      .workspace-section-card {
        padding: 20px;
      }

      .workspace-section-card h2 {
        font-size: 1.5em;
      }
    }

    @media (max-width: 700px) {
      .sidebar {
        display: none;
      }

      .main-content-area {
        width: 100%;
        margin-top: 0;
        border-top-left-radius: 10px;
        border-bottom-left-radius: 10px;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="8" width="16" height="16" rx="4" fill="#38BDF8" />
          <rect x="32" y="8" width="16" height="16" rx="4" fill="#0EA5E9" />
          <rect x="20" y="32" width="16" height="16" rx="4" fill="#06B6D4" />
          <rect x="20" y="20" width="16" height="16" rx="4" fill="#1E293B" />
        </svg>
        <div>
          <span class="brand">CODE4WEB</span>
          <div class="slogan">Designed by SeroTech</div>
        </div>
      </div>
      <nav>
        <ul>


          <li class="nav-item active" data-page="workspace" onclick="window.location.href='workspace.html'">
            <button class="nav-btn">Workspace</button>
          </li>
          <li class="nav-item" id="auth-links">
            <button class="nav-btn" onclick="openLogin()">Login</button>
          </li>
          <li class="nav-item" id="user-links" style="display: none;">
            <button class="nav-btn" onclick="logout()">Logout</button>
          </li>
        </ul>
      </nav>
      <div id="user-greeting">
        Hi, <span id="user-name"></span>
      </div>
    </div>
  </header>

  <div id="workspace-authorized-content" style="display: none;">
    <div class="main-wrapper">
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul>
            <li data-page="previous-designs"><a href="previous_designs.html">Previous Designs</a></li>
            <li class="active" data-page="workspace"><a href="workspace.html">Workspace</a></li>
            <li data-page="tutorials"><a href="#">Tutorials/Guide</a></li>
          </ul>
        </nav>
        <div class="sidebar-user">
          <p>Username: <span id="sidebar-username">Guest</span></p>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </aside>

      <main class="main-content-area">
        <section class="workspace-section-card">
          <h2>Generate Code from Wireframe</h2>



          <div class="image-upload-area" id="dropArea">
            <label for="imageUpload" class="upload-label" id="uploadLabel">
              <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path
                  d="M10 2a.75.75 0 01.75.75v6.5h6.5a.75.75 0 010 1.5h-6.5v6.5a.75.75 0 01-1.5 0v-6.5h-6.5a.75.75 0 010-1.5h6.5v-6.5A.75.75 0 0110 2z">
                </path>
              </svg>
              Upload Wireframe Here
            </label>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            <img id="imagePreview" src="#" alt="Image Preview" style="display: none;">
            <p id="fileName"></p>
            <button id="removeImageBtn" class="download-code-btn" style="display: none; margin-top: 10px;">Remove Image</button>
          </div>

          <button id="generateCodeBtn" class="workspace-cta-btn">Generate Code!</button>
          <p id="statusMessage"></p>
        </section>

        <!-- Export Controls -->
        <div class="import-export-controls" style="display: flex; gap: 16px; margin-bottom: 24px;">
          <button id="exportBtn" class="download-code-btn">Export All as ZIP</button>
        </div>
        <!-- File Picker for Export -->
        <div id="filePickerContainer" style="margin-bottom: 16px;"></div>
        <button id="refreshFilesBtn" class="download-code-btn" style="margin-bottom: 16px;">Refresh File List</button>
        <script>
          // Render file picker list
          function renderFilePicker() {
            const db = firebase.firestore();
            db.collection('html_css_files').orderBy('timestamp', 'desc').get().then((querySnapshot) => {
              const container = document.getElementById('filePickerContainer');
              container.innerHTML = '<strong>Select files to export:</strong><form id="filePickerForm">';
              querySnapshot.forEach((doc, i) => {
                const data = doc.data();
                const ext = data.type === 'html' ? 'html' : 'css';
                const label = data.filename ? data.filename : `file_${i+1}.${ext}`;
                container.innerHTML += `<div><label><input type="checkbox" name="file" value="${doc.id}"> ${label} (${ext})</label></div>`;
              });
              container.innerHTML += '</form>';
            });
          }
          // Initial render
          renderFilePicker();
          document.getElementById('refreshFilesBtn').onclick = renderFilePicker;
          // Export selected files as ZIP
          document.getElementById('exportBtn').onclick = async function() {
            const db = firebase.firestore();
            const checked = Array.from(document.querySelectorAll('#filePickerForm input[type=checkbox]:checked')).map(cb => cb.value);
            if (checked.length === 0) {
              alert('Please select at least one file to export.');
              return;
            }
            const zip = new JSZip();
            for (const id of checked) {
              const doc = await db.collection('html_css_files').doc(id).get();
              if (doc.exists) {
                const data = doc.data();
                const ext = data.type === 'html' ? 'html' : 'css';
                // Use proper filename or generate a meaningful one
                let name;
                if (data.filename && data.filename.trim() !== '') {
                  name = data.filename;
                } else if (data.timestamp) {
                  const date = data.timestamp.toDate ? data.timestamp.toDate() : new Date();
                  const timestamp = date.toISOString().slice(0, 19).replace(/:/g, '-');
                  name = `generated_${timestamp}.${ext}`;
                } else {
                  name = `file_${id}.${ext}`;
                }
                zip.file(name, data.content);
              }
            }
            const blob = await zip.generateAsync({type: 'blob'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'selected_files.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          };
        </script>

        <!-- Make sure to include JSZip library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

        <section class="workspace-section-card code-inspector-section">
          <!-- Theme Selector UI -->
          <div style="margin-bottom: 18px; display: flex; align-items: center; gap: 12px;">
            <label for="css-theme-selector" style="font-weight: bold; color: #2563eb;">CSS Theme:</label>
            <select id="css-theme-selector" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc;">
              <option value="espresso">Espresso (Coffee)</option>
              <option value="modern">Modern</option>
              <option value="minimal">Minimal</option>
              <option value="dark">Dark</option>
            </select>
            <span id="theme-selected-msg" style="color: #64748b; font-size: 0.95em;"></span>
          </div>
          <!-- Two-pane Inspector/Code section -->
          <div class="two-pane-layout">
            <!-- Inspector (left) -->
            <div class="inspector-pane">
              <h3>Inspector</h3>
              <iframe id="inspector-preview" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
            <!-- Code (middle) -->
            <div class="code-pane">
              <h3>Code (HTML)</h3>
              <textarea id="workspace-html-editor">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Page Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;This is a Heading&lt;/h1&gt;
  &lt;p&gt;This is a paragraph.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</textarea>
              <button id="saveHtmlBtn2" class="download-code-btn">Save as HTML file</button>
            </div>
            <!-- CSS (right) -->
            <div class="css-pane">
              <h3>Code (CSS)</h3>
              <textarea id="workspace-css-editor">body {\n  background: #fff;\n  color: #232946;\n}\nh1 {\n  color: #38bdf8;\n}</textarea>
              <button id="saveCssBtn" class="download-code-btn">Save as CSS file</button>
            </div>
          </div>
          <script>
            // Save as HTML file functionality for workspace editor
            document.getElementById('saveHtmlBtn2').onclick = function() {
              const code = document.getElementById('workspace-html-editor').value;
              const blob = new Blob([code], { type: 'text/html' });
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'workspace.html';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              // Save HTML to Firestore
              const db = firebase.firestore();
              db.collection('html_css_files').add({
                type: 'html',
                content: code,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
              }).then(() => {
                console.log('HTML saved to Firestore!');
              }).catch((error) => {
                console.error('Error saving HTML to Firestore:', error);
              });
            };
            // Save as CSS file functionality
            document.getElementById('saveCssBtn').onclick = function() {
              const css = document.getElementById('workspace-css-editor').value;
              const blob = new Blob([css], { type: 'text/css' });
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'workspace.css';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              // Save CSS to Firestore
              const db = firebase.firestore();
              db.collection('html_css_files').add({
                type: 'css',
                content: css,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
              }).then(() => {
                console.log('CSS saved to Firestore!');
              }).catch((error) => {
                console.error('Error saving CSS to Firestore:', error);
              });
            };
            // Realtime Inspector Preview
            function updateInspectorPreview() {
              try {
                const html = document.getElementById('workspace-html-editor').value;
                const css = document.getElementById('workspace-css-editor').value;
                const iframe = document.getElementById('inspector-preview');
                
                if (iframe) {
                  const doc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generated Website Preview</title>
  <style>${css}</style>
</head>
<body>${html}</body>
</html>`;
                  
                  iframe.srcdoc = doc;
                  console.log('Live preview updated successfully');
                } else {
                  console.warn('Preview iframe not found');
                }
              } catch (error) {
                console.error('Error updating preview:', error);
              }
            }
            document.getElementById('workspace-html-editor').addEventListener('input', updateInspectorPreview);
            document.getElementById('workspace-css-editor').addEventListener('input', updateInspectorPreview);
            // Initial preview
            updateInspectorPreview();
          </script>
        </section>
      </main>
    </div>
  </div>

  <div class="access-denied-message" id="accessDeniedMessage">
    <h2>Access Denied</h2>
    <p>Please log in to access your workspace. You will be redirected to the home page shortly.</p>
    <button class="hero-btn" onclick="openLogin()">Login Now</button>
  </div>


  <div class="signup-modal" id="signupModal">
    <div class="signup-content">
      <button class="close-btn" onclick="closeSignup()">&times;</button>
      <form id="signupForm" class="signup-form">
        <h2>Join Image2Web</h2>
        <div class="form-group">
          <label for="username">Username</label>
          <input id="signup-username" name="username" type="text" placeholder="Enter your username" required>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input id="signup-email" name="email" type="email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input id="signup-password" name="password" type="password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="signup-btn" style="width: 100%; margin: 0;">
          Create Account
        </button>
        <div class="success-message" id="successMessage" style="display:none;">
          <h3>🎉 Welcome to CODE4WEB!</h3>
          <p>Your account has been created successfully.</p>
        </div>
      </form>
    </div>
  </div>

  <div class="login-modal" id="loginModal">
    <div class="login-content">
      <button class="close-btn" onclick="closeLogin()">&times;</button>
      <form class="login-form" id="loginForm">
        <h2 class="login-title">Login to Image2Web</h2>
        <div class="form-group">
          <label for="login-username">Email</label>
          <input type="email" id="login-username" name="login-username" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" name="login-password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="login-btn" style="width: 100%; margin: 0;">
          Login
        </button>
      </form>
    </div>
  </div>

  <div class="about-modal" id="aboutModal">
    <div class="about-content">
      <button class="close-btn" onclick="closeAbout()">&times;</button>
      <h2 class="about-title">About Image2Web</h2>
      <p class="about-text">
        Image2Web is a project dedicated to transforming wireframes into beautiful, responsive websites with ease. Our
        mission is to empower developers and designers to bring their ideas to life faster and more efficiently.
      </p>
      <p class="about-text">
        <strong>Team:</strong> Moyano, Sarge Dave M. • Mallari, Merick Joshua • Quiambao, Christian Joshua • Dizon,
        Robby
      </p>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3 class="footer-title">About Image2Web</h3>
        <p class="footer-text">
          Image2Web is a tool that helps you turn your wireframes and images into real, responsive websites in seconds.
          Built for developers and designers by SeroTech.
        </p>
        <div class="social-links">
        </div>
      </div>
      <div class="footer-section">
        <h3 class="footer-title">Quick Links</h3>
        <a href="#" class="footer-link" onclick="window.location.href='index.html'">Home</a>
        <a href="#" class="footer-link" onclick="openAbout(); return false;">About</a>
        <a href="#" class="footer-link">Blog</a>
      </div>
      <div class="footer-section">
        <a href="#" class="footer-link">Tutorials</a>
      </div>
      <div class="footer-section">
        <h3 class="footer-title">Contact</h3>
        <p class="footer-text">📧 our email</p>
        <p class="footer-text">📍 A Wireframe to Website Generator</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p class="footer-text">&copy; 2025 Image2Web. All rights reserved. | Crafted with ❤️ for developers</p>
    </div>
  </footer>

  <div id="loading-spinner"
    style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);">
    <div
      style="border:8px solid #eee;border-top:8px solid #0ea5e9;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;">
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDA9TT-iCH515H63y-4zJkTJ1tZAOU7m60",
      authDomain: "image2web-1a6c0.firebaseapp.com",
      projectId: "image2web-1a6c0",
      storageBucket: "image2web-1a6c0.appspot.com",
      messagingSenderId: "167811907825",
      appId: "1:167811907825:web:809c410fefc52de3542950",
      measurementId: "G-LF3Y1S5M47"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    // Helper functions for modals (assuming they are in script.js or a global scope)
    function openLogin() {
      document.getElementById('loginModal').classList.add('active');
    }

    function closeLogin() {
      document.getElementById('loginModal').classList.remove('active');
    }

    function openSignup() {
      document.getElementById('signupModal').classList.add('active');
    }

    function closeSignup() {
      document.getElementById('signupModal').classList.remove('active');
    }

    function openAbout() {
      document.getElementById('aboutModal').classList.add('active');
    }

    function closeAbout() {
      document.getElementById('aboutModal').classList.remove('active');
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        console.log("User logged out");
        window.location.href = 'index.html'; // Redirect to home after logout
      }).catch((error) => {
        console.error("Logout Error:", error);
        alert("Logout failed: " + error.message);
      });
    }

    // Workspace Functionality JavaScript
    document.addEventListener('DOMContentLoaded', () => {
      const imageUpload = document.getElementById('imageUpload');
      const imagePreview = document.getElementById('imagePreview');
      const fileNameDisplay = document.getElementById('fileName');
      const generateCodeBtn = document.getElementById('generateCodeBtn');
      const statusMessage = document.getElementById('statusMessage');
      const loadingSpinner = document.getElementById('loading-spinner');
      const selectModel = document.getElementById('selectModel');
      const websiteDescription = document.getElementById('websiteDescription');
      const codeDisplay = document.getElementById('codeDisplay');
      const saveHtmlBtn = document.getElementById('saveHtmlBtn');
      const sidebarUsernameSpan = document.getElementById('sidebar-username');

      const workspaceAuthorizedContent = document.getElementById('workspace-authorized-content');
      const accessDeniedMessage = document.getElementById('accessDeniedMessage');
      const body = document.body;

      // Initial state: hide authorized content and access denied message
      workspaceAuthorizedContent.style.display = 'none';
      accessDeniedMessage.style.display = 'none';

      // Check if there's a project to load from previous designs
      function checkForProjectToLoad() {
        try {
          const projectData = localStorage.getItem('image2web_project_to_load');
          if (projectData) {
            const project = JSON.parse(projectData);
            console.log('Loading project from previous designs:', project);
            
            // Clear the localStorage
            localStorage.removeItem('image2web_project_to_load');
            
            // Load the project data into the workspace
            loadProjectIntoWorkspace(project.id);
          }
        } catch (error) {
          console.error('Error loading project from localStorage:', error);
          localStorage.removeItem('image2web_project_to_load');
        }
      }

      // Function to load project data into workspace
      async function loadProjectIntoWorkspace(projectId) {
        try {
          const user = firebase.auth().currentUser;
          if (!user) return;

          const db = firebase.firestore();
          const projectDoc = await db.collection('users').doc(user.uid).collection('projects').doc(projectId).get();
          
          if (projectDoc.exists) {
            const projectData = projectDoc.data();
            console.log('Project data loaded:', projectData);
            
            // Update the workspace with project data
            // Prefer direct content if available, fallback to URLs
            if (projectData.htmlContent) {
              document.getElementById('workspace-html-editor').value = projectData.htmlContent;
            } else if (projectData.htmlUrl) {
              try {
                const htmlResponse = await fetch(projectData.htmlUrl);
                if (htmlResponse.ok) {
                  const htmlContent = await htmlResponse.text();
                  document.getElementById('workspace-html-editor').value = htmlContent;
                }
              } catch (htmlError) {
                console.warn('Could not fetch HTML content:', htmlError);
              }
            }

            if (projectData.cssContent) {
              document.getElementById('workspace-css-editor').value = projectData.cssContent;
            } else if (projectData.cssUrl) {
              try {
                const cssResponse = await fetch(projectData.cssUrl);
                if (cssResponse.ok) {
                  const cssContent = await cssResponse.text();
                  document.getElementById('workspace-css-editor').value = cssContent;
                }
              } catch (cssError) {
                console.warn('Could not fetch CSS content:', cssError);
              }
            }
            
            // Update the preview
            updateInspectorPreview();
            
            // Show success message
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
              statusMessage.textContent = `Project "${projectData.name || 'Untitled'}" loaded successfully! 🎉`;
              statusMessage.style.color = '#10b981';
            }
          }
        } catch (error) {
          console.error('Error loading project into workspace:', error);
        }
      }

      // Firebase Authentication Check
      firebase.auth().onAuthStateChanged(user => {
        const authLinks = document.getElementById('auth-links');
        const userLinks = document.getElementById('user-links');
        const userGreeting = document.getElementById('user-greeting');
        const userNameSpan = document.getElementById('user-name');

        if (user) {
          // User is signed in. Allow access to workspace.
          console.log("User is logged in:", user.email);
          workspaceAuthorizedContent.style.display = 'flex'; // Show workspace content (assuming main-wrapper uses flex)
          accessDeniedMessage.style.display = 'none'; // Hide access denied message

          // Update header for logged-in user
          authLinks.style.display = 'none';
          userLinks.style.display = 'list-item';
          userGreeting.style.display = 'block';
          userNameSpan.textContent = user.displayName || user.email || 'User';
          sidebarUsernameSpan.textContent = user.displayName || user.email || 'User';

          // Check if there's a project to load from previous designs
          checkForProjectToLoad();


        } else {
          // User is logged out. Show access denied message and redirect.
          console.log("User is logged out. Access denied.");
          workspaceAuthorizedContent.style.display = 'none'; // Hide workspace content
          accessDeniedMessage.style.display = 'block'; // Show access denied message

          // Update header for logged-out user
          authLinks.style.display = 'list-item';
          userLinks.style.display = 'none';
          userGreeting.style.display = 'none';
          userNameSpan.textContent = '';
          sidebarUsernameSpan.textContent = 'Guest';

          // Redirect to home page after a delay
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000); // Redirect after 2 seconds
        }
        body.classList.add('loaded'); // Ensure body becomes visible after auth check
      });


      // Drag and Drop functionality
      const dropArea = document.getElementById('dropArea');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
      });

      dropArea.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        imageUpload.files = files;
        imageUpload.dispatchEvent(new Event('change'));
      }

      // Handle image file selection (from click or drag-drop)
      imageUpload.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          const reader = new FileReader();
          reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            fileNameDisplay.textContent = file.name;
            statusMessage.textContent = '';
            
            // Hide upload button and show remove button
            document.getElementById('uploadLabel').style.display = 'none';
            document.getElementById('removeImageBtn').style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        } else {
          imagePreview.src = '#';
          imagePreview.style.display = 'none';
          fileNameDisplay.textContent = '';
          
          // Show upload button and hide remove button
          document.getElementById('uploadLabel').style.display = 'inline-flex';
          document.getElementById('removeImageBtn').style.display = 'none';
        }
      });

      // Handle remove image button
      document.getElementById('removeImageBtn').addEventListener('click', function() {
        imageUpload.value = '';
        imagePreview.src = '#';
        imagePreview.style.display = 'none';
        fileNameDisplay.textContent = '';
        
        // Show upload button and hide remove button
        document.getElementById('uploadLabel').style.display = 'inline-flex';
        document.getElementById('removeImageBtn').style.display = 'none';
      });

      // Handle Generate Code button click
      generateCodeBtn.addEventListener('click', async () => {
        if (!imageUpload.files || imageUpload.files.length === 0) {
          statusMessage.textContent = 'Please select an image first.';
          statusMessage.style.color = '#f5576c';
          return;
        }

        const file = imageUpload.files[0];
        statusMessage.textContent = 'Detecting elements in your wireframe...';
        statusMessage.style.color = '#ffe066';
        loadingSpinner.style.display = 'flex';
        generateCodeBtn.disabled = true;

        try {
          // Step 1: Detect elements using /api/detect
          const detectFormData = new FormData();
          detectFormData.append('image', file);
          
          const detectResponse = await fetch('/api/detect', {
            method: 'POST',
            body: detectFormData
          });

          if (!detectResponse.ok) {
            throw new Error(`Detection failed: ${detectResponse.status}`);
          }

          const detectResult = await detectResponse.json();
          
          if (!detectResult.success) {
            throw new Error(detectResult.error || 'Detection failed');
          }

          // Show detection results
          statusMessage.textContent = `Detected ${detectResult.elements.length} elements! Generating website...`;
          statusMessage.style.color = '#10b981';

          // Step 2: Generate website using /api/generates
          const generateFormData = new FormData();
          generateFormData.append('image', file);
          // Get selected theme from dropdown
          const selectedTheme = document.getElementById('css-theme-selector').value;
          generateFormData.append('theme', selectedTheme);
          document.getElementById('theme-selected-msg').textContent = `Theme: ${selectedTheme.charAt(0).toUpperCase() + selectedTheme.slice(1)}`;
          
          const generateResponse = await fetch('/api/generate', {
            method: 'POST',
            body: generateFormData
          });

          if (!generateResponse.ok) {
            throw new Error(`Generation failed: ${generateResponse.status}`);
          }

          const generateResult = await generateResponse.json();
          
          if (!generateResult.success) {
            throw new Error(generateResult.error || 'Generation failed');
          }

          // Debug: Log what the API actually returned
          console.log('API Response:', generateResult);
          console.log('HTML content available:', !!generateResult.html_content);
          console.log('CSS content available:', !!generateResult.css_content);
          console.log('HTML URL:', generateResult.html_url);
          console.log('CSS URL:', generateResult.css_url);

          // Success! Show results
          statusMessage.textContent = 'Website generated successfully! 🎉';
          statusMessage.style.color = '#10b981';

          // Display the generated HTML and CSS in the workspace editors
          const htmlEditor = document.getElementById('workspace-html-editor');
          const cssEditor = document.getElementById('workspace-css-editor');
          
          // Get the raw HTML and CSS content from the API response
          // The API should return the actual content, not just URLs
          let htmlContent = '';
          let cssContent = '';
          
          // Try to get content from the API response if available
          if (generateResult.html_content) {
            htmlContent = generateResult.html_content;
          } else if (generateResult.html_url) {
            // Fallback: fetch from URL if content not provided directly
            try {
              const htmlResponse = await fetch(generateResult.html_url);
              if (htmlResponse.ok) {
                htmlContent = await htmlResponse.text();
              }
            } catch (htmlError) {
              console.warn('Could not fetch HTML content:', htmlError);
            }
          }
          
          if (generateResult.css_content) {
            cssContent = generateResult.css_content;
          } else if (generateResult.css_url) {
            // Fallback: fetch from URL if content not provided directly
            try {
              const cssResponse = await fetch(generateResult.css_url);
              if (cssResponse.ok) {
                cssContent = await cssResponse.text();
              }
            } catch (cssError) {
              console.warn('Could not fetch CSS content:', cssError);
            }
          }
          
          // Set default content if nothing was fetched
          if (!htmlContent) {
            htmlContent = `<!-- Generated HTML from wireframe -->
<!-- HTML file available at: ${generateResult.html_url} -->
<!-- Note: Raw HTML content not available from API. This is a fallback message. -->
<!-- The actual generated HTML should appear here if the API is working correctly. -->
<div style="padding: 20px; border: 2px dashed #ccc; text-align: center;">
  <h3>HTML Generation Successful!</h3>
  <p>Your wireframe has been converted to HTML.</p>
  <p><strong>Detected Elements:</strong> ${detectResult.elements.length}</p>
  <p><strong>HTML File:</strong> <a href="${generateResult.html_url}" target="_blank">View Generated HTML</a></p>
  <p><em>Note: Raw HTML code should appear here. If you see this message, the API needs to be updated.</em></p>
</div>`;
          }
          
          if (!cssContent) {
            cssContent = `/* Generated CSS from wireframe */
/* CSS file available at: ${generateResult.css_url} */
/* Note: Raw CSS content not available from API. This is a fallback message. */
/* The actual generated CSS should appear here if the API is working correctly. */

body { 
  background: #fff; 
  font-family: Arial, sans-serif;
  padding: 20px;
}

.fallback-message {
  border: 2px dashed #ccc;
  padding: 20px;
  text-align: center;
  margin: 20px 0;
}

.fallback-message h3 {
  color: #333;
  margin-bottom: 10px;
}

.fallback-message p {
  margin: 5px 0;
  color: #666;
}

.fallback-message a {
  color: #007bff;
  text-decoration: none;
}

.fallback-message a:hover {
  text-decoration: underline;
}`;
          }
          
          // Populate the editors with the raw content
          htmlEditor.value = htmlContent;
          cssEditor.value = cssContent;
          
          console.log('HTML content populated:', htmlContent.length, 'characters');
          console.log('CSS content populated:', cssContent.length, 'characters');

          // Update the preview
          updateInspectorPreview();

          // Save project to Firestore
          const user = firebase.auth().currentUser;
          if (user) {
            const db = firebase.firestore();
            
            // Only save essential, simple data to avoid Firestore issues
            const projectData = {
              name: String(file.name.split('.')[0] || 'Generated Design'),
              description: String(`Wireframe converted to website with ${detectResult.elements.length} detected elements`),
              modelUsed: String('Image2Web Wireframe Detector'),
              htmlUrl: String(generateResult.html_url),
              cssUrl: String(generateResult.css_url),
              htmlContent: htmlContent, // Store the actual HTML code
              cssContent: cssContent,   // Store the actual CSS code
              elementCount: Number(detectResult.elements.length),
              imageDimensions: {
                width: Number(detectResult.image_dimensions.width),
                height: Number(detectResult.image_dimensions.height)
              },
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              websiteUrl: String('#'),
              note: 'Element details omitted due to Firestore data structure limitations'
            };
            
            try {
              await db.collection('users').doc(user.uid).collection('projects').add(projectData);
              console.log("Project saved to Firestore successfully!");
            } catch (firestoreError) {
              console.error('Failed to save project to Firestore:', firestoreError);
              // Don't crash the app - just log the error and continue
              statusMessage.textContent = 'Code generated successfully! (Project save failed)';
            }
          }

          // Show download links
          const downloadSection = document.createElement('div');
          downloadSection.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
              <h4 style="margin: 0 0 10px 0; color: #0ea5e9;">Generated Files</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="${generateResult.html_url}" target="_blank" style="background: #0ea5e9; color: white; padding: 8px 16px; text-decoration: none; border-radius: 6px; font-weight: 600;">📄 View HTML</a>
                <a href="${generateResult.css_url}" target="_blank" style="background: #0ea5e9; color: white; padding: 8px 16px; text-decoration: none; border-radius: 6px; font-weight: 600;">🎨 View CSS</a>
              </div>
              <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #64748b;">
                <strong>Detected elements:</strong> ${detectResult.elements.length} | 
                <strong>Image:</strong> ${detectResult.image_dimensions.width} × ${detectResult.image_dimensions.height}px
              </p>
            </div>
          `;
          
          // Insert after the status message
          statusMessage.parentNode.insertBefore(downloadSection, statusMessage.nextSibling);

          // Add visual feedback that the editors have been populated
          htmlEditor.style.borderColor = '#10b981';
          cssEditor.style.borderColor = '#10b981';
          setTimeout(() => {
            htmlEditor.style.borderColor = '';
            cssEditor.style.borderColor = '';
          }, 2000);

          // Scroll to the code inspector section to show the generated code
          const codeInspectorSection = document.querySelector('.code-inspector-section');
          if (codeInspectorSection) {
            codeInspectorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }

          // Add a success message above the code inspector
          const successMessage = document.createElement('div');
          successMessage.innerHTML = `
            <div style="margin-bottom: 20px; padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #10b981;">
              <h4 style="margin: 0 0 10px 0; color: #10b981;">✨ Code Generated Successfully!</h4>
              <p style="margin: 0; color: #065f46;">
                Your HTML and CSS code has been populated in the editors below. 
                Edit the code to customize your website, and see live previews in real-time!
              </p>
            </div>
          `;
          
          // Insert the success message above the code inspector
          const codeInspectorTitle = document.querySelector('.code-inspector-section h2');
          if (codeInspectorTitle) {
            codeInspectorTitle.parentNode.insertBefore(successMessage, codeInspectorTitle.nextSibling);
          }

        } catch (error) {
          console.error('Wireframe processing failed:', error);
          statusMessage.textContent = `Error: ${error.message}. Please try again.`;
          statusMessage.style.color = '#f5576c';
        } finally {
          loadingSpinner.style.display = 'none';
          generateCodeBtn.disabled = false;
        }
      });

      // Handle Save as HTML file button click
      saveHtmlBtn.addEventListener('click', () => {
        const generatedCode = codeDisplay.querySelector('code').textContent;
        const blob = new Blob([generatedCode], {
          type: 'text/html'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'generated_website.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      // Helper function to escape HTML for display
      function escapeHtml(html) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(html));
        return div.innerHTML;
      }

      // Sidebar navigation active state (Client-side only)
      const sidebarNavItems = document.querySelectorAll('.sidebar-nav li');
      const currentPage = "workspace";
      sidebarNavItems.forEach(item => {
        if (item.dataset.page === currentPage) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    });
  </script>
  <button id="nav-toggle" aria-label="Open navigation" style="display:none;">
    &#9776;
  </button>
</body>

</html>