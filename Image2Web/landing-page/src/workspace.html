<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Your personal workspace on Image2Web. Manage your projects and conversions here. Designed by SeroTech.">
  <title>IMAGE2WEB - Your Workspace</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css?family=Russo+One&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    /* Mobile-first responsive styles */
    body {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    body.loaded {
      opacity: 1;
    }

    .access-denied-message {
      display: none;
      text-align: center;
      margin: 50px 20px;
      font-size: 1.2em;
      color: var(--danger-red);
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--modal-content-bg);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .access-denied-message h2 {
      color: var(--primary-blue);
      margin-bottom: 15px;
      font-size: 1.5em;
    }

    .access-denied-message p {
      margin-bottom: 25px;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .access-denied-message .hero-btn {
      padding: 12px 25px;
      font-size: 1em;
      border-radius: 50px;
    }

    /* Mobile-optimized workspace layout */
    .main-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding-top: 10px;
    }

    .sidebar {
      width: 100%;
      background: var(--modal-content-bg);
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 15px;
      order: 2;
    }

    .sidebar-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .sidebar-nav li a,
    .logout-btn {
      display: block;
      padding: 8px 12px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 5px;
      transition: background 0.2s ease, color 0.2s ease;
      font-size: 0.9em;
      white-space: nowrap;
    }

    .sidebar-nav li a:hover,
    .logout-btn:hover {
      background: rgba(56, 189, 248, 0.1);
      color: var(--primary-blue);
    }

    .sidebar-nav li.active a {
      background: var(--primary-blue);
      color: var(--button-text);
      font-weight: bold;
    }

    .sidebar-user {
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
      margin-top: 15px;
      text-align: center;
    }

    .sidebar-user p {
      color: var(--text-primary);
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .logout-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      cursor: pointer;
      width: 100%;
      font-family: 'Russo One', Arial, sans-serif;
    }

    .main-content-area {
      flex-grow: 1;
      padding: 15px;
      background: var(--background-light);
      order: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Workspace section cards */
    .workspace-section-card {
      background: var(--modal-content-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .workspace-section-card h2 {
      font-family: 'Russo One', sans-serif;
      color: var(--primary-blue);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.5em;
      text-align: center;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
      text-align: left;
      font-size: 0.9em;
    }

    /* Image upload area */
    .image-upload-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1.5rem;
      border: 2px dashed var(--primary-blue);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      min-height: 120px;
      justify-content: center;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .image-upload-area.drag-over {
      background-color: rgba(56, 189, 248, 0.1);
      border-color: var(--secondary-blue);
    }

    .upload-label {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--primary-blue);
      color: var(--button-text);
      border-radius: 50px;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
      font-size: 0.9em;
    }

    .upload-label:hover {
      background: var(--secondary-blue);
      transform: translateY(-2px);
    }

    #imagePreview {
      max-width: 100%;
      max-height: 150px;
      border-radius: 8px;
      margin-top: 1rem;
      object-fit: contain;
      border: 1px solid var(--border-color);
      display: none;
    }

    #fileName {
      margin-top: 10px;
      font-size: 0.9em;
      color: var(--text-secondary);
      word-break: break-all;
    }

    /* Code inspector section */
    .code-inspector-section {
      background: var(--modal-content-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .code-inspector-section h2 {
      font-family: 'Russo One', sans-serif;
      color: var(--primary-blue);
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5em;
      text-align: center;
    }

    /* Mobile-optimized two-pane layout */
    .two-pane-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto auto;
  gap: 16px;
    }

    .inspector-pane, .code-pane, .css-pane {
      background: #232946;
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .inspector-pane h3, .code-pane h3, .css-pane h3 {
      color: #38bdf8;
      margin-bottom: 12px;
      font-size: 1.1em;
      text-align: center;
    }

    /* Inspector spans full width and is taller for readable preview */
    #inspector-preview {
      width: 100%;
      height: 500px;
      background: #181823;
      border: 2px dashed #38bdf8;
      border-radius: 8px;
    }

    /* Editors should expand to show full content; autosize handled by JS */
    .code-pane textarea, .css-pane textarea {
      width: 100%;
      min-height: 120px;
      border-radius: 8px;
      padding: 10px;
      background: #181823;
      color: #fff;
      font-size: 0.85em;
      border: 1px solid #38bdf8;
      margin-bottom: 12px;
      resize: none;
      overflow: hidden; /* hide internal scrollbar; JS will expand height */
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
    }

    #saveHtmlBtn2, #saveCssBtn {
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 0.9em;
      cursor: pointer;
      align-self: center;
      width: 100%;
      max-width: 160px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #saveHtmlBtn2 {
      background: #a259ff;
      color: #fff;
    }

    #saveHtmlBtn2:hover {
      background: #8b47d4;
      transform: translateY(-2px);
    }

    #saveCssBtn {
      background: #38bdf8;
      color: #fff;
    }

    #saveCssBtn:hover {
      background: #0ea5e9;
      transform: translateY(-2px);
    }

    /* Export controls */
    .import-export-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    #exportBtn, #refreshFilesBtn {
      background: var(--tertiary-blue);
      color: var(--button-text);
      padding: 10px 16px;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      font-family: 'Russo One', Arial, sans-serif;
      font-size: 0.9em;
      text-align: center;
    }

    #exportBtn:hover, #refreshFilesBtn:hover {
      background: #0ea5e9;
      transform: translateY(-2px);
    }

    #filePickerContainer {
      margin-bottom: 15px;
      font-size: 0.9em;
    }

    #filePickerContainer strong {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    #filePickerContainer label {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    #filePickerContainer input[type="checkbox"] {
      margin-right: 8px;
    }

    /* Status message */
    #statusMessage {
      margin-top: 15px;
      font-size: 0.9em;
      text-align: center;
      min-height: 20px;
    }

    /* Mobile hamburger menu */
    #nav-toggle {
      display: block;
      background: none;
      border: none;
      color: var(--primary-blue);
      font-size: 1.8em;
      cursor: pointer;
      z-index: 1003;
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 5px;
      transition: transform 0.3s ease;
    }

    /* Tablet styles */
    @media (min-width: 768px) {
      .main-wrapper {
        flex-direction: row;
        padding-top: 20px;
      }
      
      .sidebar {
        width: 200px;
        min-width: 200px;
        border-right: 1px solid var(--border-color);
        border-bottom: none;
        border-radius: 10px 0 0 10px;
        order: 1;
      }
      
      .sidebar-nav ul {
        flex-direction: column;
      }
      
      .main-content-area {
        padding: 20px;
        border-radius: 0 10px 10px 0;
        order: 2;
      }
      
      .two-pane-layout {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      .inspector-pane {
        flex: 1 1 100%;
        order: 1;
      }
      
      .code-pane, .css-pane {
        flex: 1 1 calc(50% - 8px);
      }
      
      .code-pane {
        order: 2;
      }
      
      .css-pane {
        order: 3;
      }
      
      .import-export-controls {
        flex-direction: row;
      }
    }

    /* Desktop styles */
    @media (min-width: 1024px) {
      .sidebar {
        width: 250px;
      }

      .main-content-area {
        padding: 20px 40px;
      }

      /* Desktop layout: inspector spans full width on first row, editors sit side-by-side under it */
      .two-pane-layout {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        gap: 20px;
      }

      .inspector-pane {
        grid-column: 1 / -1; /* span full width */
      }

      .code-pane {
        grid-column: 1 / 2;
      }

      .css-pane {
        grid-column: 2 / 3;
      }

      #inspector-preview {
        height: 500px;
      }

      .code-pane textarea, .css-pane textarea {
        min-height: 220px;
      }
    }

    /* Large desktop styles */
    @media (min-width: 1200px) {
      #inspector-preview {
        height: 60vh;
      }

      .code-pane textarea, .css-pane textarea {
        min-height: 300px;
      }
    }

    /* Loading spinner */
    #loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2000;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="8" width="16" height="16" rx="4" fill="#38BDF8" />
          <rect x="32" y="8" width="16" height="16" rx="4" fill="#0EA5E9" />
          <rect x="20" y="32" width="16" height="16" rx="4" fill="#06B6D4" />
          <rect x="20" y="20" width="16" height="16" rx="4" fill="#1E293B" />
        </svg>
        <div>
          <span class="brand">IMAGE2WEB</span>
          <div class="slogan">Designed by SeroTech</div>
        </div>
      </div>
      <nav>
        <ul>
          <li class="nav-item active" data-page="workspace" onclick="window.location.href='workspace.html'">
            <button class="nav-btn">Workspace</button>
          </li>
          <li class="nav-item" id="auth-links">
            <button class="nav-btn" onclick="openLogin()">Login</button>
          </li>
          <li class="nav-item" id="user-links" style="display: none;">
            <button class="nav-btn" onclick="logout()">Logout</button>
          </li>
        </ul>
      </nav>
      <div id="user-greeting">
        Hi, <span id="user-name"></span>
      </div>
      <button id="nav-toggle" aria-label="Open navigation">&#9776;</button>
    </div>
  </header>

  <div id="workspace-authorized-content" style="display: none;">
    <div class="main-wrapper">
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul>
            <li data-page="previous-designs"><a href="previous_designs.html">Previous Designs</a></li>
            <li class="active" data-page="workspace"><a href="workspace.html">Workspace</a></li>
            <li data-page="tutorials"><a href="#">Tutorials/Guide</a></li>
          </ul>
        </nav>
        <div class="sidebar-user">
          <p>Username: <span id="sidebar-username">Guest</span></p>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </aside>

      <main class="main-content-area">
        <section class="workspace-section-card">
          <h2>Generate Code from Wireframe</h2>

          <div class="image-upload-area" id="dropArea">
            <label for="imageUpload" class="upload-label" id="uploadLabel">
              <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="20" height="20">
                <path
                  d="M10 2a.75.75 0 01.75.75v6.5h6.5a.75.75 0 010 1.5h-6.5v6.5a.75.75 0 01-1.5 0v-6.5h-6.5a.75.75 0 010-1.5h6.5v-6.5A.75.75 0 0110 2z">
                </path>
              </svg>
              Upload Wireframe Here
            </label>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            <img id="imagePreview" src="#" alt="Image Preview" style="display: none;">
            <p id="fileName"></p>
            <button id="removeImageBtn" class="download-code-btn" style="display: none; margin-top: 10px;">Remove Image</button>
          </div>

          <button id="generateCodeBtn" class="workspace-cta-btn">Generate Code!</button>
          <button id="viewGeneratedBtn" class="workspace-cta-btn" style="margin-left:16px;background:#7dd3fc;color:#08203a;">View HTML/CSS</button>
          <p id="statusMessage"></p>
        </section>

  <!-- Export controls removed -->

        <section class="workspace-section-card code-inspector-section">
          <!-- Two-pane Inspector/Code section -->
          <h2>Code Inspector</h2>
          <div class="two-pane-layout">
            <!-- Inspector (left) -->
            <div class="inspector-pane">
              <h3>Inspector</h3>
              <iframe id="inspector-preview" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
            <!-- Code (middle) -->
            <div class="code-pane">
              <h3>Code (HTML)</h3>
              <textarea id="workspace-html-editor">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Page Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;This is a Heading&lt;/h1&gt;
  &lt;p&gt;This is a paragraph.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</textarea>
              <button id="saveHtmlBtn2">Save as HTML file</button>
            </div>
            <!-- CSS (right) -->
            <div class="css-pane">
              <h3>Code (CSS)</h3>
              <textarea id="workspace-css-editor">body {
  background: #fff;
  color: #232946;
}
h1 {
  color: #38bdf8;
}</textarea>
              <button id="saveCssBtn">Save as CSS file</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div class="access-denied-message" id="accessDeniedMessage">
    <h2>Access Denied</h2>
    <p>Please log in to access your workspace. You will be redirected to the home page shortly.</p>
    <button class="hero-btn" onclick="openLogin()">Login Now</button>
  </div>

  <!-- Modals and footer remain the same as in your original code -->
  <div class="signup-modal" id="signupModal">
    <div class="signup-content">
      <button class="close-btn" onclick="closeSignup()">&times;</button>
      <form id="signupForm" class="signup-form">
        <h2>Join Image2Web</h2>
        <div class="form-group">
          <label for="username">Username</label>
          <input id="signup-username" name="username" type="text" placeholder="Enter your username" required>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input id="signup-email" name="email" type="email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input id="signup-password" name="password" type="password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="signup-btn" style="width: 100%; margin: 0;">
          Create Account
        </button>
        <div class="success-message" id="successMessage" style="display:none;">
          <h3>üéâ Welcome to IMAGE2WEB!</h3>
          <p>Your account has been created successfully.</p>
        </div>
      </form>
    </div>
  </div>

  <div class="login-modal" id="loginModal">
    <div class="login-content">
      <button class="close-btn" onclick="closeLogin()">&times;</button>
      <form class="login-form" id="loginForm">
        <h2 class="login-title">Login to Image2Web</h2>
        <div class="form-group">
          <label for="login-username">Email</label>
          <input type="email" id="login-username" name="login-username" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" name="login-password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="login-btn" style="width: 100%; margin: 0;">
          Login
        </button>
      </form>
    </div>
  </div>

  <div class="about-modal" id="aboutModal">
    <div class="about-content">
      <button class="close-btn" onclick="closeAbout()">&times;</button>
      <h2 class="about-title">About Image2Web</h2>
      <p class="about-text">
        Image2Web is a project dedicated to transforming wireframes into beautiful, responsive websites with ease. Our
        mission is to empower developers and designers to bring their ideas to life faster and more efficiently.
      </p>
      <p class="about-text">
        <strong>Team:</strong> Moyano, Sarge Dave M. ‚Ä¢ Mallari, Merick Joshua ‚Ä¢ Quiambao, Christian Joshua ‚Ä¢ Dizon,
        Robby
      </p>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3 class="footer-title">About Image2Web</h3>
        <p class="footer-text">
          Image2Web is a tool that helps you turn your wireframes and images into real, responsive websites in seconds.
          Built for developers and designers by SeroTech.
        </p>
        <div class="social-links">
        </div>
      </div>
      <div class="footer-section">
        <h3 class="footer-title">Quick Links</h3>
        <a href="#" class="footer-link" onclick="window.location.href='index.html'">Home</a>
        <a href="#" class="footer-link" onclick="openAbout(); return false;">About</a>
        <a href="#" class="footer-link">Blog</a>
      </div>
      <div class="footer-section">
        <a href="#" class="footer-link">Tutorials</a>
      </div>
      <div class="footer-section">
        <h3 class="footer-title">Contact</h3>
        <p class="footer-text">üìß our email</p>
        <p class="footer-text">üìç A Wireframe to Website Generator</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p class="footer-text">&copy; 2025 Image2Web. All rights reserved. | Crafted with ‚ù§Ô∏è for developers</p>
    </div>
  </footer>

  <div id="loading-spinner">
    <div
      style="border:8px solid #eee;border-top:8px solid #0ea5e9;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;">
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // Firebase initialization and configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDA9TT-iCH515H63y-4zJkTJ1tZAOU7m60",
      authDomain: "image2web-1a6c0.firebaseapp.com",
      projectId: "image2web-1a6c0",
      storageBucket: "image2web-1a6c0.appspot.com",
      messagingSenderId: "167811907825",
      appId: "1:167811907825:web:809c410fefc52de3542950",
      measurementId: "G-LF3Y1S5M47"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    // Helper functions for modals
    function openLogin() {
      document.getElementById('loginModal').classList.add('active');
    }

    function closeLogin() {
      document.getElementById('loginModal').classList.remove('active');
    }

    function openSignup() {
      document.getElementById('signupModal').classList.add('active');
    }

    function closeSignup() {
      document.getElementById('signupModal').classList.remove('active');
    }

    function openAbout() {
      document.getElementById('aboutModal').classList.add('active');
    }

    function closeAbout() {
      document.getElementById('aboutModal').classList.remove('active');
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        console.log("User logged out");
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error("Logout Error:", error);
        alert("Logout failed: " + error.message);
      });
    }

    // Mobile navigation toggle
    document.getElementById('nav-toggle').addEventListener('click', function() {
      const nav = document.querySelector('nav ul');
      nav.classList.toggle('open');
      document.querySelector('.mobile-overlay').classList.toggle('active');
    });

    // Workspace Functionality JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      const imageUpload = document.getElementById('imageUpload');
      const imagePreview = document.getElementById('imagePreview');
      const fileNameDisplay = document.getElementById('fileName');
      const generateCodeBtn = document.getElementById('generateCodeBtn');
      const statusMessage = document.getElementById('statusMessage');
      const loadingSpinner = document.getElementById('loading-spinner');
      const workspaceAuthorizedContent = document.getElementById('workspace-authorized-content');
      const accessDeniedMessage = document.getElementById('accessDeniedMessage');
      const body = document.body;

      // Initial state
      workspaceAuthorizedContent.style.display = 'none';
      accessDeniedMessage.style.display = 'none';

      // Firebase Authentication Check
      firebase.auth().onAuthStateChanged(user => {
        const authLinks = document.getElementById('auth-links');
        const userLinks = document.getElementById('user-links');
        const userGreeting = document.getElementById('user-greeting');
        const userNameSpan = document.getElementById('user-name');
        const sidebarUsernameSpan = document.getElementById('sidebar-username');

        if (user) {
          // User is signed in
          console.log("User is logged in:", user.email);
          workspaceAuthorizedContent.style.display = 'flex';
          accessDeniedMessage.style.display = 'none';

          authLinks.style.display = 'none';
          userLinks.style.display = 'list-item';
          userGreeting.style.display = 'block';
          userNameSpan.textContent = user.displayName || user.email || 'User';
          sidebarUsernameSpan.textContent = user.displayName || user.email || 'User';
        } else {
          // User is logged out
          console.log("User is logged out. Access denied.");
          workspaceAuthorizedContent.style.display = 'none';
          accessDeniedMessage.style.display = 'block';

          authLinks.style.display = 'list-item';
          userLinks.style.display = 'none';
          userGreeting.style.display = 'none';
          userNameSpan.textContent = '';
          sidebarUsernameSpan.textContent = 'Guest';

          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        }
        body.classList.add('loaded');
      });

      // Image upload functionality
      imageUpload.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          const reader = new FileReader();
          reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            fileNameDisplay.textContent = file.name;
            statusMessage.textContent = '';
            
            document.getElementById('uploadLabel').style.display = 'none';
            document.getElementById('removeImageBtn').style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        }
      });

      // Remove image button
      document.getElementById('removeImageBtn').addEventListener('click', function() {
        imageUpload.value = '';
        imagePreview.src = '#';
        imagePreview.style.display = 'none';
        fileNameDisplay.textContent = '';
        
        document.getElementById('uploadLabel').style.display = 'inline-flex';
        document.getElementById('removeImageBtn').style.display = 'none';
      });

      // Generate code button
      generateCodeBtn.addEventListener('click', async () => {
        if (!imageUpload.files || imageUpload.files.length === 0) {
          statusMessage.textContent = 'Please select an image first.';
          statusMessage.style.color = '#f5576c';
          return;
        }

        // Real API call to backend to generate HTML/CSS
        statusMessage.textContent = 'Processing your image...';
        statusMessage.style.color = '#ffe066';
        loadingSpinner.style.display = 'flex';
        generateCodeBtn.disabled = true;

        try {
          const formData = new FormData();
          formData.append('image', imageUpload.files[0]);
          // include selected theme if you add a selector later; default to espresso
          formData.append('theme', 'espresso');

          // attach a user id if available from Firebase auth
          try {
            const currentUser = firebase.auth().currentUser;
            if (currentUser) formData.append('user_id', currentUser.uid || currentUser.email || 'user');
          } catch (e) {
            // ignore
          }

          // POST to relative API path; change to your deployed URL if needed
          const resp = await fetch('/api/generate', {
            method: 'POST',
            body: formData
          });

          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || (data.message || 'Generation failed on server'));
          }

          // Populate editors with returned content (will autosize)
          setEditorContents(data.html_content, data.css_content);

          // Save latest generated content to localStorage for viewing on other page
          try {
            if (data.html_content) localStorage.setItem('generated_html', data.html_content);
            if (data.css_content) localStorage.setItem('generated_css', data.css_content);

            // Automatically add this generated result to Previous Designs (projects_list)
            try {
              const raw = localStorage.getItem('projects_list') || '[]';
              const projects = JSON.parse(raw);
              const entry = {
                id: Date.now(),
                title: `Generated ${new Date().toLocaleString()}`,
                filename: imageUpload.files && imageUpload.files[0] ? imageUpload.files[0].name : undefined,
                thumbnail: undefined,
                html: data.html_content || '',
                css: data.css_content || ''
              };
              // Try to generate a thumbnail snapshot of the generated preview (inspector) so Previous Designs shows the output
              try {
                const htmlContent = document.getElementById('workspace-html-editor').value || '';
                const cssContent = document.getElementById('workspace-css-editor').value || '';
                const maxDim = 300;

                // fallback immediate thumbnail: uploaded imagePreview if present
                const imgEl = document.getElementById('imagePreview');
                if (imgEl && imgEl.src && imgEl.src !== '#' && imgEl.style.display !== 'none') {
                  entry.thumbnail = imgEl.src;
                }

                // Asynchronously create an SVG foreignObject that wraps the generated HTML+CSS and render to canvas
                (function(html, css, entryId) {
                  try {
                    const wrapper = `<div xmlns='http://www.w3.org/1999/xhtml'><style>${css}</style>${html}</div>`;
                    // choose a render width; 900px wide is usually fine and will be scaled down
                    const renderW = 900;
                    const renderH = 600;
                    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${renderW}' height='${renderH}'><foreignObject width='100%' height='100%'>${wrapper}</foreignObject></svg>`;
                    const img = new Image();
                    img.onload = function() {
                      try {
                        // scale to maxDim preserving aspect
                        let w = img.width, h = img.height;
                        if (w > h) {
                          if (w > maxDim) { h = Math.round(h * (maxDim / w)); w = maxDim; }
                        } else {
                          if (h > maxDim) { w = Math.round(w * (maxDim / h)); h = maxDim; }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        const small = canvas.toDataURL('image/png');
                        try {
                          const raw2 = localStorage.getItem('projects_list') || '[]';
                          const list2 = JSON.parse(raw2);
                          const idx2 = list2.findIndex(p => String(p.id) === String(entryId));
                          if (idx2 !== -1) {
                            list2[idx2].thumbnail = small;
                            localStorage.setItem('projects_list', JSON.stringify(list2));
                            localStorage.setItem('projects_list_updated_at', String(Date.now()));
                          }
                        } catch (ee) { /* ignore thumbnail replace errors */ }
                      } catch (e) { /* ignore drawing errors */ }
                    };
                    img.onerror = function() { /* ignore errors */ };
                    img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
                  } catch (e) {
                    console.warn('inspector thumbnail generation failed', e);
                  }
                })(htmlContent, cssContent, entry.id);
              } catch (e) { console.warn('thumbnail generation failed', e); }
              projects.unshift(entry);
              // keep list reasonable in size (optional): keep latest 100
              if (projects.length > 100) projects.length = 100;
              localStorage.setItem('projects_list', JSON.stringify(projects));
              // If no thumbnail was produced by the snapshot logic, create a simple SVG placeholder so the card shows something
              try {
                const p0 = projects[0];
                if (!p0.thumbnail) {
                  const title = (p0.title || 'Generated').replace(/"/g, '');
                  const time = new Date(Number(p0.id) || Date.now()).toLocaleString();
                  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='140'><rect width='100%' height='100%' fill='#2a0b4a'/><text x='50%' y='45%' fill='#bfe9ff' font-size='14' text-anchor='middle' font-family='Arial, Helvetica, sans-serif'>${title}</text><text x='50%' y='70%' fill='#bfe9ff' font-size='11' text-anchor='middle' font-family='Arial, Helvetica, sans-serif'>${time}</text></svg>`;
                  p0.thumbnail = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
                  localStorage.setItem('projects_list', JSON.stringify(projects));
                }
              } catch (e) { /* ignore placeholder failure */ }
              localStorage.setItem('projects_list_updated_at', String(Date.now()));
              localStorage.setItem('projects_list_last_id', String(entry.id));
            } catch (pe) {
              console.warn('Auto-save to projects_list failed:', pe);
            }
          } catch (e) {
            console.warn('Could not save generated code to localStorage:', e);
          }

          // Update preview
          updateInspectorPreview();

          statusMessage.textContent = `Code generated successfully (${data.detected_elements || 0} elements).`;
          statusMessage.style.color = '#10b981';

          // Attempt to persist project server-side (and client-side fallback)
          try {
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
              // Call backend to save metadata/content
              try {
                const saveResp = await fetch('/api/save_project', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    user_id: currentUser.uid,
                    title: `Generated ${new Date().toLocaleString()}`,
                    html: data.html_content || '',
                    css: data.css_content || '',
                    html_url: data.html_url || '',
                    css_url: data.css_url || '',
                    elementCount: data.detected_elements || 0
                  })
                });
                const saved = await saveResp.json();
                if (saveResp.ok && saved && saved.success) {
                  // update local metadata so previous_designs shows the server id quickly
                  const lastId = localStorage.getItem('projects_list_last_id');
                  try {
                    const raw = localStorage.getItem('projects_list') || '[]';
                    const projects = JSON.parse(raw);
                    // find the entry that matches the temp id and replace its id with the real one
                    const idx = projects.findIndex(p => String(p.id) === String(lastId));
                    if (idx !== -1) {
                      projects[idx].id = saved.id;
                      localStorage.setItem('projects_list', JSON.stringify(projects));
                      // If this id was previously marked deleted locally, remove it from deleted list
                      try {
                        const deletedRaw = localStorage.getItem('projects_list_deleted_ids') || '[]';
                        let deletedArr = JSON.parse(deletedRaw);
                        deletedArr = deletedArr.filter(x => String(x) !== String(saved.id));
                        localStorage.setItem('projects_list_deleted_ids', JSON.stringify(deletedArr));
                      } catch (e) { console.warn('failed to clear deleted id after save', e); }
                    }
                  } catch (_) {}
                  localStorage.setItem('projects_list_last_id', String(saved.id));
                } else {
                  console.warn('Server-side project save responded with error', saved);
                }
              } catch (e) {
                console.warn('Server-side save failed, will attempt client-side Firestore save', e);
                // fallback: try client-side Firestore write so the project appears in the user's account immediately
                try {
                  const db = firebase.firestore();
                  await db.collection('users').doc(currentUser.uid).collection('projects').add({
                    title: `Generated ${new Date().toLocaleString()}`,
                    html: data.html_content || '',
                    css: data.css_content || '',
                    html_url: data.html_url || '',
                    css_url: data.css_url || '',
                    elementCount: data.detected_elements || 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                  });
                } catch (ee) {
                  console.warn('Client-side Firestore save also failed', ee);
                }
              }
            }
          } catch (saveErr) {
            console.warn('Could not persist project to server/firestore:', saveErr);
          }

          // After generation and persistence attempts, do NOT auto-redirect; user can click View HTML/CSS

        } catch (err) {
          console.error('Generation error:', err);
          statusMessage.textContent = 'Generation failed: ' + (err.message || err);
          statusMessage.style.color = '#f5576c';
        } finally {
          loadingSpinner.style.display = 'none';
          generateCodeBtn.disabled = false;
        }
      });

      // Save HTML and CSS functionality
      document.getElementById('saveHtmlBtn2').onclick = function() {
        const code = document.getElementById('workspace-html-editor').value;
        const blob = new Blob([code], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'workspace.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };

      document.getElementById('saveCssBtn').onclick = function() {
        const css = document.getElementById('workspace-css-editor').value;
        const blob = new Blob([css], { type: 'text/css' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'workspace.css';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };

      // Real-time preview update
      function updateInspectorPreview() {
        try {
          const html = document.getElementById('workspace-html-editor').value;
          const css = document.getElementById('workspace-css-editor').value;
          const iframe = document.getElementById('inspector-preview');
          
          if (iframe) {
            const doc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generated Website Preview</title>
  <style>${css}</style>
</head>
<body>${html}</body>
</html>`;
            
            iframe.srcdoc = doc;
          }
        } catch (error) {
          console.error('Error updating preview:', error);
        }
      }

      document.getElementById('workspace-html-editor').addEventListener('input', updateInspectorPreview);
      document.getElementById('workspace-css-editor').addEventListener('input', updateInspectorPreview);

      // Auto-resize editors so their contents are fully visible (no internal scroll)
      function autosizeTextarea(el) {
        if (!el) return;
        el.style.height = 'auto';
        const newHeight = Math.min(Math.max(el.scrollHeight, 120), 2000);
        el.style.height = newHeight + 'px';
      }

      const htmlEditor = document.getElementById('workspace-html-editor');
      const cssEditor = document.getElementById('workspace-css-editor');
      htmlEditor.addEventListener('input', () => autosizeTextarea(htmlEditor));
      cssEditor.addEventListener('input', () => autosizeTextarea(cssEditor));

      // Ensure editors resize when content is programmatically set
      function setEditorContents(html, css) {
        if (typeof html !== 'undefined' && html !== null) {
          htmlEditor.value = html;
          autosizeTextarea(htmlEditor);
        }
        if (typeof css !== 'undefined' && css !== null) {
          cssEditor.value = css;
          autosizeTextarea(cssEditor);
        }
      }

      // Initial preview and size
      autosizeTextarea(htmlEditor);
      autosizeTextarea(cssEditor);
      updateInspectorPreview();

      // If another page asked us to open a project, load it now
      try {
        const toLoadRaw = localStorage.getItem('image2web_project_to_load');
        if (toLoadRaw) {
          try {
            const payload = JSON.parse(toLoadRaw);
            if (payload && (payload.html || payload.css)) {
              // populate editors and preview
              setEditorContents(payload.html || '', payload.css || '');
              updateInspectorPreview();
              // ensure generated_html/generated_css are set for viewer pages
              try { if (payload.html) localStorage.setItem('generated_html', payload.html); } catch(e){}
              try { if (payload.css) localStorage.setItem('generated_css', payload.css); } catch(e){}
            }
          } catch (e) { console.warn('Failed to parse image2web_project_to_load', e); }
          // remove the stash so it doesn't keep reloading on refresh
          try { localStorage.removeItem('image2web_project_to_load'); } catch (e) {}
        }
      } catch (e) { /* ignore */ }

  // View HTML/CSS button: open generated output viewer (reads generated_html/generated_css from localStorage)
  const viewBtn = document.getElementById('viewGeneratedBtn');
  if (viewBtn) viewBtn.addEventListener('click', () => { window.location.href = 'generated_output.html'; });

  // File export functionality removed
    });
  </script>
</body>

</html>